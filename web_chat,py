import streamlit as st
import openai
import os
from dotenv import load_dotenv

load_dotenv()

openai.api_key = os.getenv('OPENAI_API_KEY')


@st.cache_data
def complete_text(prompt_user, token, engine):
    if prompt_user:
        prompt_user = f"Act as a professional AI automation system capable of providing concise and accurate answers " \
                      f"to various questions. Focus on understanding the problem or question at hand and provide " \
                      f"brief responses without excessive descriptions. Prompt: {prompt_user}"

        response = openai.Completion.create(
            engine=engine,
            prompt=prompt_user,
            max_tokens=token,
            temperature=0.7,
            n=1,
            stop=None
        )
        if response.choices and len(response.choices) > 0:
            return response.choices[0].text
        else:
            return "[AI]: Unable to generate a response."
    else:
        return "[AI]: Please type something."


def main():
    st.title("OpenAI Conversation")
    
    try:
        st.markdown('## USER: [+] ask me something')
        prompt = st.text_input('', key='input_prompt')
        tokens = st.slider('Number of Tokens', min_value=10, max_value=500, value=100)
        engine = st.selectbox('Engine', ['text-davinci-003', 'text-davinci-004'])
        if prompt:
            st.write(complete_text(prompt, tokens, engine))
    except openai.error.APIError as error_api:
        st.write('[ERROR]: You missed the API key. Please make sure to set a valid API key. '
                 'You can obtain an OpenAI API key by visiting this link: https://platform.openai.com/account/api-keys.'
                 f'Error message: {error_api}')
    except openai.error.InvalidRequestError as invalid:
        st.write('[ERROR]: Something went wrong. Please try again.\nError message: {invalid}')
    except KeyboardInterrupt:
        st.write('[INFO]: The script was closed by the user.')


if __name__ == "__main__":
    main()
